apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: samba
  name: samba
  # We wish this deployment to be reloaded
  # when "velocity-config" ConfigMap are updated
  annotations:
    configmap.reloader.stakater.com/reload: "velocity-config"
spec:
  # レプリカ数の制御を ScaledObject に任せるため、 replicas は指定しない
  # 参考: https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#replicas
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: samba
  template:
    metadata:
      labels:
        app: samba
    spec:
      containers:
        # https://github.com/ServerContainers/samba/
        - env:
            - name: SAMBA_CONF_SERVER_STRING
              value: topi-datastore
            - name: ACCOUNT_topi
              value: "topi:1000:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:026D3A1B6B259F8117869B6785857E7B:[U          ]:LCT-652FA929:"
            - name: ACCOUNT_test
              value: "test:1000:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:4E60D5ED9A15B870B134F14C3D2E8727:[U          ]:LCT-652FB150:"
            - name: SAMBA_VOLUME_CONFIG_homes
              value: >-
                path = /homes/%U;
                comment = %U - topi-datastore;
                browseable = no;
                writable = yes;
          image: servercontainers/samba
          name: samba
          ports:
            - name: cifs
              containerPort: 445
            - name: fileprinters
              containerPort: 139
            - name: nameservice
              containerPort: 137
          volumeMounts:
            - name: velocity-config
              mountPath: /config/velocity.toml
              subPath: velocity.toml
            - name: velocity-config
              mountPath: /config/forwarding.secret
              subPath: forwarding.secret
